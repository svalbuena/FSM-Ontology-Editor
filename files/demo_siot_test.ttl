@prefix :      <file:///D:/projects/ontologies/siot/demo_siot.ttl#> .
@prefix http-methods: <http://www.w3.org/2011/http-methods#> .
@prefix fsm:   <file:///D:/projects/ontologies/fsm/fsm.ttl#> .
@prefix rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix xml:   <http://www.w3.org/2001/XMLSchema#> .
@prefix http:  <http://www.w3.org/2011/http#> .
@prefix rdfs:  <http://www.w3.org/2000/01/rdf-schema#> .

:sendMyDatabody  a       fsm:Body ;
        fsm:hasBodyType  fsm:rdf ;
        fsm:hasContent   "@prefix siot: <file:///D:/projects/ontologies/siot/siot.owl#> .\n@prefix owl: <http://www.w3.org/2002/07/owl#> .\n@prefix fsm: <file:///D:/projects/ontologies/fsm/fsm.owl#> .\n\nself: a siot:Node .\nself: siot:hasData self:data .\nself:data a siot:Data .\nself:data fsm:hasContent \"My data\" ." .

:S3_to_S5_Transition  a         fsm:Transition ;
        fsm:hasSourceState      :S3_CheckCompatibilityState ;
        fsm:hasTargetState      :S5_NotCompatibleState ;
        fsm:hasTransitionGuard  :S3_to_S5_T_Guard .

:S5_NotCompatibleState
        a                   fsm:State , fsm:SimpleState ;
        fsm:hasEntryAction  :sendImNotCompatible .

:checkCompatibilityBody
        a                fsm:Body ;
        fsm:hasBodyType  fsm:rdf ;
        fsm:hasContent   "@prefix siot: <file:///D:/projects/ontologies/siot/siot.owl#> .\n@prefix owl: <http://www.w3.org/2002/07/owl#> .\n@prefix fsm: <file:///D:/projects/ontologies/fsm/fsm.owl#> .\n\nself: a siot:Node .\nself: siot:hasData self:data1 .\nself:data1 a siot:Data .\nself:data1 fsm:hasContent \"data of node 1\" .\nself:node2 a siot:Node .\nself:node2 siot:hasData self:data2 .\nself:data2 a siot:Data .\nself:data2 fsm:hasContent \"data of node 2\" ." .

:S2_to_S3_Transition  a         fsm:Transition ;
        fsm:hasSourceState      :S2_InformationExchangeState ;
        fsm:hasTargetState      :S3_CheckCompatibilityState ;
        fsm:hasTransitionGuard  :S2_to_S3_T_Guard .

:S2_InformationExchangeState
        a                   fsm:State , fsm:SimpleState ;
        fsm:hasEntryAction  :sendMyData .

:IsPeerNotCompatible  a  fsm:Condition ;
        fsm:hasContent  "PREFIX siot: <file:///D:/projects/ontologies/siot/siot.owl#>\nPREFIX owl: <http://www.w3.org/2002/07/owl#>\nPREFIX fsm: <file:///D:/projects/ontologies/fsm/fsm.owl#>\n\nASK {\n    self: siot:hasPeer ?peer .\n    self: siot:hasCompatibility ?compatibility .\n    ?compatibility siot:withPeer ?peer .\n    ?compatibility fsm:hasContent \"false\" .\n}" .

:sendImCompatible  a         fsm:Action ;
        fsm:hasBody          :sendImCompatibleBody ;
        fsm:hasPrototypeURI  :sendDataPrototype ;
        fsm:hasTimeoutInMs   "1000"^^xml:long ;
        http:mthd            http-methods:POST .

:S2_to_S3_T_Guard  a           fsm:Guard ;
        fsm:hasGuardCondition  :IsPeerDataAvailable .

:IsPeerAvailable  a     fsm:Condition ;
        fsm:hasContent  "PREFIX siot: <file:///D:/projects/ontologies/siot/siot.owl#>\nPREFIX owl: <http://www.w3.org/2002/07/owl#>\nPREFIX fsm: <file:///D:/projects/ontologies/fsm/fsm.owl#>\n\nASK {\n    self: siot:hasPeer ?peer .\n    ?peer fsm:hasContent  ?value .\n}" .

:sendMyData  a               fsm:Action ;
        fsm:hasBody          :sendMyDatabody ;
        fsm:hasPrototypeURI  :sendDataPrototype ;
        fsm:hasTimeoutInMs   "1000"^^xml:long ;
        http:mthd            http-methods:POST .

:S6_to_S7_Transition  a         fsm:Transition ;
        fsm:hasSourceState      :S6_WaitingForPeerCompatibilityState ;
        fsm:hasTargetState      :S7_CompareCompatibilitiesState ;
        fsm:hasTransitionGuard  :S6_to_S7_T_Guard .

:sendImNotCompatibleBody
        a                fsm:Body ;
        fsm:hasBodyType  fsm:rdf ;
        fsm:hasContent   "@prefix siot: <file:///D:/projects/ontologies/siot/siot.owl#> .\n@prefix owl: <http://www.w3.org/2002/07/owl#> .\n@prefix fsm: <file:///D:/projects/ontologies/fsm/fsm.owl#> .\n\nself: siot:hasCompatibility ?compatibility .\n?compatibility siot:withPeer self:myPeer .\n?compatibility fsm:hasContent \"false\" ." .

:sendImNotCompatible  a      fsm:Action ;
        fsm:hasBody          :sendImNotCompatibleBody ;
        fsm:hasPrototypeURI  :sendDataPrototype ;
        fsm:hasTimeoutInMs   "1000"^^xml:long ;
        http:mthd            http-methods:POST .

:sendDataPrototype  a     fsm:PrototypeURI ;
        fsm:hasParameter  :peerUriParameter ;
        fsm:hasStructure  "[peer_uri]/send_data" .

:S1_to_S2_Transition  a         fsm:Transition ;
        fsm:hasSourceState      :S1_WatingForPeerState ;
        fsm:hasTargetState      :S2_InformationExchangeState ;
        fsm:hasTransitionGuard  :S1_to_S2_T_Guard .

:S7_CompareCompatibilitiesState
        a       fsm:State , fsm:FinalState .

:S3_CheckCompatibilityState
        a                   fsm:State , fsm:SimpleState ;
        fsm:hasEntryAction  :checkCompatibility .

:S1_to_S2_T_Guard  a           fsm:Guard ;
        fsm:hasGuardCondition  :IsPeerAvailable .

:checkCompatibility  a      fsm:Action ;
        fsm:hasBody         :checkCompatibilityBody ;
        fsm:hasTimeoutInMs  "10"^^xml:long ;
        http:absoluteURI    "http://localhost:9000/check_compatibility" ;
        http:mthd           http-methods:POST .

:IsPeerDataAvailable  a  fsm:Condition ;
        fsm:hasContent  "PREFIX siot: <file:///D:/projects/ontologies/siot/siot.owl#>\nPREFIX owl: <http://www.w3.org/2002/07/owl#>\n\nASK {\n    self: siot:hasPeer ?peer .\n    ?peer siot:hasData ?data .\n}" .

:S5_to_S6_Transition  a     fsm:Transition ;
        fsm:hasSourceState  :S5_NotCompatibleState ;
        fsm:hasTargetState  :S6_WaitingForPeerCompatibilityState .

:S3_to_S4_T_Guard  a           fsm:Guard ;
        fsm:hasGuardCondition  :IsPeerCompatible .

:sendImCompatibleBody
        a                fsm:Body ;
        fsm:hasBodyType  fsm:rdf ;
        fsm:hasContent   "@prefix siot: <file:///D:/projects/ontologies/siot/siot.owl#> .\n@prefix owl: <http://www.w3.org/2002/07/owl#> .\n@prefix fsm: <file:///D:/projects/ontologies/fsm/fsm.owl#> .\n\nself: siot:hasCompatibility :compatibility2 .\n:compatibility2 siot:withPeer <http://localhost:9000/test_client> .\n:compatibility2 fsm:hasContent \"true\" ." .

:peerUriParameter  a        fsm:PrototypeParameter ;
        fsm:hasPlaceholder  "[peer_uri]" ;
        fsm:hasQuery        "    \n\t\tPREFIX siot: <file:///D:/projects/ontologies/siot/siot.owl#>\n\n\t\tSELECT (str(?peer) as ?peer_uri)\n\t\tWHERE\n\t\t{\n\t\t\tself: siot:hasPeer ?peer\n\t\t}\n" .

:siot_fsm  a          fsm:StateMachine ;
        fsm:contains  :S2_to_S3_Transition , :S3_to_S5_Transition , :S6_to_S7_Transition , :S2_InformationExchangeState , :S5_to_S6_Transition , :S4_IsCompatibleState , :S4_to_S6_Transition , :S1_to_S2_Transition , :S6_WaitingForPeerCompatibilityState , :S5_NotCompatibleState , :S1_WatingForPeerState , :S7_CompareCompatibilitiesState , :S3_to_S4_Transition , :S3_CheckCompatibilityState .

:S6_to_S7_T_Guard  a           fsm:Guard ;
        fsm:hasGuardCondition  :IsPeerCompatibilityAvailable .

:IsPeerCompatible  a    fsm:Condition ;
        fsm:hasContent  "PREFIX siot: <file:///D:/projects/ontologies/siot/siot.owl#>\nPREFIX owl: <http://www.w3.org/2002/07/owl#>\nPREFIX fsm: <file:///D:/projects/ontologies/fsm/fsm.owl#>\n\nASK {\n    self: siot:hasPeer ?peer .\n    self: siot:hasCompatibility ?compatibility .\n    ?compatibility siot:withPeer ?peer .\n    ?compatibility fsm:hasContent \"true\" .\n}" .

:S4_IsCompatibleState
        a                   fsm:State , fsm:SimpleState ;
        fsm:hasEntryAction  :sendImCompatible .

:S3_to_S5_T_Guard  a           fsm:Guard ;
        fsm:hasGuardCondition  :IsPeerNotCompatible .

:S4_to_S6_Transition  a     fsm:Transition ;
        fsm:hasSourceState  :S4_IsCompatibleState ;
        fsm:hasTargetState  :S6_WaitingForPeerCompatibilityState .

:S1_WatingForPeerState
        a       fsm:State , fsm:InitialState .

:S3_to_S4_Transition  a         fsm:Transition ;
        fsm:hasSourceState      :S3_CheckCompatibilityState ;
        fsm:hasTargetState      :S4_IsCompatibleState ;
        fsm:hasTransitionGuard  :S3_to_S4_T_Guard .

:IsPeerCompatibilityAvailable
        a               fsm:Condition ;
        fsm:hasContent  "PREFIX siot: <file:///D:/projects/ontologies/siot/siot.owl#>\nPREFIX owl: <http://www.w3.org/2002/07/owl#>\n\nASK {\n    self: siot:hasPeer ?peer .\n    ?peer siot:hasCompatibility ?compatibility .\n\n}" .

:S6_WaitingForPeerCompatibilityState
        a       fsm:State , fsm:SimpleState .
